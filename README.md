# next-workbox

> Next.js plugin for workbox

# Installation

```sh
npm install --save next-workbox
```
or

```
yarn add next-workbox
```

# Usage

This next.js plugin powered by [next-workbox-webpack-plugin](https://github.com/ragingwind/next-workbox-webpack-plugin). which mean you can use [almost all options](https://github.com/ragingwind/next-workbox-webpack-plugin#usage) of the webpack plugin except `distDir` and `buildId`. Both thse options are overridden and handled by this plugin.

```js
// next.config.js
const withWorkbox = require('next-workbox')

module.exports = withWorkbox({
    workbox: {
      // https://github.com/ragingwind/next-workbox-webpack-plugin#usage
      ...webpackOptions,
      // register server worker script with default value or your own content
      registerSW: true // boolean or string
    }
})
```

## Register service worker

To register the service worker script generated by workbox, you must call service worker APIs in your application. There are many ways to do this, but we recommend adding the `<ServiceWoerk>` component provided with this package to a custome  `Document` (for more information about using a custom `Document` component, please see [Next's documentation](https://github.com/zeit/next.js/#custom-document)):

```js
import Document, {Head, Main, NextScript} from 'next/document'
import flush from 'styled-jsx/server'
import ServiceWorker from 'next-workbox/service-worker'

export default class extends Document {
	render() {
		return (
			<html lang="en">
				<Head/>
				<body>
					<Main />
					<NextScript />
          <ServiceWorker
              src={'/sw.js'}
              scope={'/'}
              unregister={process.env.NODE_ENV !== 'production'}
          />
				</body>
			</html>
		)
	}
}
```

An alternative method to do this would be to use the plugin directly by setting it up to register the service worker code into the main chunk of your application. This can easily be done by adding a `registerSW` property to your `next.config.js`. `registerSW` takes either a `boolean` or a string with a path to the script:

```js
// next.config.js
const withWorkbox = require('next-workbox')

module.exports = withWorkbox({
  workbox: {
    registerSW: true
  }
})
```

or with string content

```js
// next.config.js
const withWorkbox = require('next-workbox')

module.exports = withWorkbox({
  workbox: {
    registerSW: readFileSync('./register-sw.js')
  }
})
```

## Default src and scope of service worker

Out of the box, this plugin doesn't allow changing the src and\or scope of service worker. Rather, it uses the default path and scope, under `static/workbox`, which is generated by this plugin. As a result, an additional http header of `'Service-Worker-Allowed', '/'` must be set by the server to cache the files on the root. Here is the sample code for that.

```js
app.prepare().then(() => {
  createServer((req, res) => {
    if (req.url.startsWith('/static/')) {
      res.setHeader('Service-Worker-Allowed', '/')
      app.serveStatic(req, res, join(root, `.${req.url}`))
    } else {
      handle(req, res, req.url)
    }
  }).listen(port, err => {
    if (err) {
      throw err
    }
    console.log(`> Ready on http://localhost:${port}`)
  })
})
```

If you do need to make changes these settings, you can use your own script to register the service worker as outlined above.

## License

MIT Â© [Jimmy Moon](https://ragingwind.me)
